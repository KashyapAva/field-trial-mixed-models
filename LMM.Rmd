---
title: "Crop_data"
author: "Kashyap Ava"
date: "2025-11-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Loading

```{r}
data = read.csv("/Users/kashyapava/Downloads/LTCCE-HP_2068-2023.csv", header = TRUE)
head(data)
```

```{r}
dim(data)
```

The dimensions of the data is 15296 rows and 10 columns.

```{r}
summary(data)
```

Lets first understand the variables and then do an exploratory data analysis.

## Exploratory Data Analysis:

```{r}
unique(data["Expt"])
```

```{r}
unique(data["Site"])
```

```{r}
unique(data["Season"])
```

```{r}
unique(data["Afactor"])
```

```{r}
unique(data["Bfactor"])
```

```{r}
unique(data["B_label"])
```

```{r}
unique(data["Rep"])
```

```{r}
unique(data["A_label"])
```


```{r}
colnames(data)
```


Column	Meaning	Role in Design	How we'll treat it

Expt variable: Experiment ID that identifies a trial series	Random.
It has only one unique value. Not a factor in the analysis

Site variable: Field location / station.
It has only one unique value. Not a factor in the analysis

Year variable:	Year of trial.
Year: The data is from the years 1968 to 2023.

Season variable: Represents the season Wet/Dry/Monsoon etc.
It has 3 unique values DS (Dry Season), EWS (Early Wet Season), and LWS (Late Wet Season).

Afactor	variable: Primary treatment factor and is a	fixed effect
It has 4 unique values: F1, F2, F3, F4.

A_label variable: Label for Afactor. It contains the value of the corresponding Afactor variable.
It ranges from 0 to 195. It has 30 unique values.

Bfactor variable: Secondary factor. Could be block OR treatment-B	and need to inspect values.
It has 6 unique values: V1, V2, V3, V4, V5, V6.

B_label	variable: Label for Bfactor. 
It is a character variable and has 97 unique values.

Rep	variable: Replication / Block number. It is a classic RCBD blocking factor.
It has 4 unique values: 1, 2, 3, 4.

GYtha: Grain Yield (tons/hectare) It is a continuous response variable. 
It has over 5000 unique values so is clearly not categorical.

## Feature Engineering:

Lets dive into the type of variables that we are dealing with to understand the variables of interest.

The inferences from the data exploration are:

Expt:	Only 1 experiment. That means there are no random effect across experiments. Not a variable of interest.

Site:	Only 1 site. This imples that there is no location variability and so is a single-environment trial. Not a variable of interest

Year:	Many years and there is a "Rep" variable. So it is a repeated long-term trial. This is a variable of interest for understanding temporal variation.

Season:	3 seasons. It captures the variation in seasonal environments (Dry / Early Wet / Late Wet). This is a variable of interest for seasonal variation of yield.

Afactor: Primary factor F1–F4 (fixed). It is a categorical variable of interest. It is the first treatment effect.

A_label: Levels for the primary factor (30 unique values). It is the measure of the primary factor in the block. It can be considered continuous or categorical.

Bfactor: Secondary factor V1–V6 (likely variety groups / fertility classes etc.). It is a categorical variable of interest. It is the second treatment effect.

B_label: Levels for Bfactor (97 levels!) → specific varieties / treatments. It is the measure of the secondary factor in the block. It can be considered continuous or categorical. Likely for it to be continuous in this case.

Rep:	4 replications → classic RCBD structure

Response variable:	GYtha = yield


## Data Cleaning

Lets first check for null values.

```{r}
for (c in colnames(data))
  print(c(c, ":", sum(is.na(data[c]))))
print(sum(is.na(data)))
```

There are 298 null values in the data and all of them are in the response variable column.

The data has 15926 rows, out of which 298 are null (around 1.8%). We can safely remove them and proceed with the modeling.

```{r}
data_clean <- na.omit(data)
head(data_clean)
```

```{r}
for (c in colnames(data_clean))
  print(c(c, ":", sum(is.na(data_clean[c]))))
print(sum(is.na(data_clean)))
```


Now that we have the cleaned data set "data_clean". Lets get into the modeling approaches.

## Determing the exact variables from the reference paper

Information from the paper:

The experimental design was a randomized split plot with four N fertilizer rates (no applied N and three rates of increasing N) as main plots, three to six rice cultivars as subplots, and four replications. 

Inference 1:

The Afactor is the Nitrogen fertilizer rates. It is hence a fixed treatment factor.

The A_label is the actual Nitrogen fertilizer dosage within each group. So it is numerical level and hence can be considered as a continuous variable.

The Bfactor might be the cultivars factor mentioned. It is hence a fixed treatment factor.

The B_label is the specific cultivar name. So it is a unique name for each cultivar and hence is a categorical variable.



## Modeling approaches:


The core idea of the choosing the appropriate model is the choice of the fixed and random effects.

The predictors of interest are: Year, Season, Afactor, Bfactor, Rep

Response variable: Yield

We need to understand the difference in yields for different seasons, different Afactors and different Bfactors.

So that means, Season, Afactor and Bfactor are fixed effects.

Year and Rep are random effects as we are not interested in comparing yield differences.

Referring back to the paper:

"The experimental design was a randomized split plot with four N fertilizer rates (no applied N and three rates of increasing N) as main plots, three to six rice cultivars as subplots, and four replications."

This implies that for one main plot a particular fertilizer rate was used, and then within that same main plot, there were different sub plots for which different cultivars were used.


So the yield Y(ijk) in main plot A(i) with cultivar B(j) in block k, the modeling equation for one year and one particular season is as follows:

$$
Y_{ijk} = \mu + A_i + B_j + (A * B)_{ij} + u_k + u_{ik} + \epsilon_{ijk}
\\
where:
\\
u_k = N(0, \sigma^2_{block})
\\
u_{ik} = N(0, \sigma^2_{A,block})
\\
\epsilon_{ijk} = N(0, \sigma^2)
$$

We extend the above model to multi-year and multi-season with season also to be a fixed effect. We do inlcude the interaction terms between season and the other fixed effects.

$$
Y_{ijkst} = \mu + S_s + A_i + B_j + (A * B)_{ij} + (A * S)_{is} + (S * B)_{sj} + (A * B * S)_{ijs} + u_t + u_{ts} + u_{tsk} + u_{tski} +  \epsilon_{ijkst}
\\
where:
\\
u_t = N(0, \sigma^2_{Year})
\\
u_{ts} = N(0, \sigma^2_{Year, Season})
\\
u_{tsk} = N(0, \sigma^2_{Year, Season, Rep})
\\
u_{tski} = N(0, \sigma^2_{Year, Season, Rep, A})
\\
\epsilon_{ijkst} = N(0, \sigma^2)
$$

Lets use the lme4 library to code this mixed effects model.

```{r}
library(lme4)
library(lmerTest)
library(emmeans)
library(dplyr)


# ensure factor types
data_lmm <- data_clean %>%
  mutate(
    Year    = factor(Year),
    Season  = factor(Season, levels = c("DS","EWS","LWS")),
    Rep     = factor(Rep),
    Afactor = factor(Afactor, levels = c("F1", "F2", "F3", "F4")),  # F1–F4
    Bfactor = factor(Bfactor, levels = c("V1","V2","V3","V4","V5","V6"))   # V1–V6
  )

fit <- lmer(GYtha ~ Season * Afactor * Bfactor + (1 | Year/Season/Rep/Afactor), data = data_lmm)
summary(fit)
```


Since one of the variance is zero and all the third order interaction terms are insignificant, this implies that this model does fit the data well and so let us reduce it to just have the second order interactions.


```{r}
library(lme4)
library(lmerTest)

fit2 <- lmer(
  GYtha ~ Season * Afactor + Season * Bfactor + Afactor * Bfactor +
    (1 | Year) + 
    (1 | Year:Rep) +  
    (1 | Year:Rep:Afactor),
  data = data_lmm
)

summary(fit2)
```


We see that the variance of Year:Rep is zero implying that blocks (rep) do not contribute variation beyond the year. So this term can be exclude from the model.


```{r}
library(lme4)
library(lmerTest)

fit3 <- lmer(
  GYtha ~ Season * Afactor + Season * Bfactor + Afactor * Bfactor +
    (1 | Year) + 
    (1 | Year:Rep:Afactor),
  data = data_lmm
)

summary(fit3)
```

All the fixed effects are significant, some of the second order interactions are significant.


Though these confidence intervals gives us the significances, we must check them more robustly using F-tests and so lets use the anova.

```{r}
anova(fit3, type = 3)
```

The A * B interaction term is not statistically significant from the above results and hence can be removed from the modeling.

```{r}
library(lme4)
library(lmerTest)

fit4 <- lmer(
  GYtha ~ Season * Afactor + Season * Bfactor + (1 | Year) + (1 | Year:Rep:Afactor),
  data = data_lmm
)

summary(fit4)
```

```{r}
anova(fit4)
```


Now lets look at the effect of each individual factors using the Estimated Marginal Means (EMM):

lets compare the effects of A and B in each season

```{r}
library(emmeans)

emm_options(lmer.df = "asymptotic")
emm_A <- emmeans(fit4, ~ Afactor | Season)
pairs(emm_A, adjust = "tukey")
emm_A
```

Inferences:

Nitrogen application significantly increased grain yield in all seasons (P < 0.001).

DS: F1 < F2 < F3 < F4

EWS: F1 < F2 < F4 ~ F3

LWS: F1 < F2 < F3 = F4


In the Dry season, yield increased progressively from F1 to F4, with F4 producing the highest yield (6.96 t/ha).


In the Early and Late Wet seasons, yield increased up to F3, beyond which no significant improvement was observed; F3 and F4 yields were statistically similar (P > 0.05 in LWS).


These results indicate stronger nitrogen responsiveness in the Dry season and a yield plateau at intermediate nitrogen rates in the Wet seasons.


Visualization of yield versus A-factor:

```{r}
library(emmeans)
library(ggplot2)
library(dplyr)

# 1) Get EMMs for Afactor within each Season
emm_A <- emmeans(fit4, ~ Afactor | Season)

# 2) Convert to a tidy data frame
df_emm <- as.data.frame(emm_A) %>%
  mutate(
    Afactor = factor(Afactor, levels = c("F1","F2","F3","F4")),  # ensure order F1→F4
    Season  = factor(Season, levels = c("DS","EWS","LWS"))
  )

# 3) Plot: points + CIs + lines, faceted by Season
ggplot(df_emm, aes(x = Afactor, y = emmean, group = 1)) +
  geom_line() +
  geom_point(size = 2.4) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.15) +
  facet_wrap(~ Season, nrow = 1) +
  labs(
    title = "Nitrogen Fertilizer Level Yield response by season",
    x = "Nitrogen Fertilizer Level",
    y = "Predicted grain yield (kg/ha)",
    #caption = "Means averaged over cultivars; CIs are Tukey-adjusted via emmeans"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold")
  )

```

Mean Differences for the Bfactor:


```{r}
emm_B <- emmeans(fit4, ~ Bfactor | Season)
pairs(emm_B, adjust = "tukey")
emm_B
```

Inferences:

V4 consistently achieved the highest yields across seasons, indicating broad adaptability and superior performance.

V1 consistently had the lowest yield, suggesting poor adaptability or genetic disadvantage.

The other cultivars (V2, V3, V5, V6) formed a middle-performing group, with moderate differences most visible in the dry season.

Visualization of the B-factor effect on yield:

```{r}
library(emmeans)
library(ggplot2)
library(dplyr)

# 1) Get EMMs for Bfactor within each Season
emm_B <- emmeans(fit4, ~ Bfactor | Season)

# 2) Convert to a tidy data frame
df_emm_B <- as.data.frame(emm_B) %>%
  mutate(
    Bfactor = factor(Bfactor, levels = c("V1","V2","V3","V4","V5","V6")),  # ensure order
    Season  = factor(Season, levels = c("DS","EWS","LWS"))
  )

# 3) Plot
ggplot(df_emm_B, aes(x = Bfactor, y = emmean, group = 1)) +
  geom_line() +
  geom_point(size = 2.4) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.15) +
  facet_wrap(~ Season, nrow = 1) +
  labs(
    title = "Cultivar Variant Yield Performance by season",
    x = "Cultivar type",
    y = "Predicted grain yield (kg/ha)",
    #caption = "Means averaged over nitrogen levels; CIs from emmeans"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold")
  )
```


Results and inferences:

1. Nitrogen response varies strongly by season:

Dry Season (DS):

- Yield climbs steadily and sharply from F1 → F4

- Biggest jump is from low to medium N (F1 → F2)

- Gains continue through F3 → F4, but smaller

- Highest productivity seen in DS F4

Inference: Dry season conditions support strong crop response to nitrogen — likely due to brighter sunlight, better drainage, and lower disease pressure.


Early Wet Season (EWS):

- Yield increases from F1 → F3

- F3 is the peak, then a slight drop at F4

- F3 and F4 are statistically similar

Inference: Wet-season conditions reduce nitrogen efficiency — crop response plateaus once moderate N is supplied.


Late Wet Season (LWS):

- Same pattern as EWS

- Yield rises F1 → F3, then levels off or slightly declines at F4

- F3 and F4 nearly overlapping

Inference: Late wet season also plateaus — excess N does not translate into yield, possibly due to nutrient losses, cloud cover, and disease/moisture stress.


Overall Inference: F4 is beneficial only in the dry season.



2. Cultivar performance also varies by season

Dry Season:

- Clear differences among cultivars

- V4 consistently highest

- V1 clearly lowest

- V2, V5, V6 cluster as strong performers just below V4

- V3 slightly weaker than V2/V5/V6, but above V1

Inference: Dry season brings out the genetic potential of cultivars — and V4 stands out strongest.


Early Wet Season:

- Differences become smaller

- V4, V2, V5, V6 all similar at the top

- V3 slightly below the top group

- V1 remains lowest

Inference: Moist-season stress reduces cultivar separation; weather masks genetic differences.


Late Wet Season:

- Yield much lower for all cultivars (season stress)

- V4 and V6 emerge slightly higher than others

- V2 & V3 mid-level

- V5 slightly lower

- V1 remains the weakest

Inference: Under most stressful seasonal conditions, cultivar differences narrow, but V4 still leads and V1 still lags.

Overall Inference: V4 is consistently superior; V1 consistently under performs.


Big-Picture Interpretation: 

- Yield potential and nitrogen efficiency are highest in the Dry season

- Wet seasons show reduced fertilizer efficiency and narrower cultivar differences

- V4 is broadly adapted — performs strongly across all seasons

- V1 consistently lowest, regardless of conditions

- Sustainable fertilizer management should not apply maximum N in wet seasons

- The story is biologically sensible and aligns with agronomic theory about light intensity, soil aeration, nutrient loss, and   disease pressure in wet seasons.


Recommendations:

- Prioritize V4 with season-specific nitrogen plans

- Avoid over-fertilization in wet seasons → economically and environmentally smarter

- Consider split N applications or slow-release fertilizer in wet seasons to reduce loss

- Monitor fields for moisture stress and disease during wet periods


## Trying out the spatial visualization:

Lets look at the overall piocture of the main plots and the sub plots over the different seasons.

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)

plot_splitplot_season <- function(df, season_label) {
  d <- data_lmm %>%
    filter(Season == season_label) %>%
    # average if multiple obs per (Rep, A, B)
    group_by(Rep, Afactor, Bfactor) %>%
    summarise(GYtha = mean(GYtha, na.rm = TRUE), .groups = "drop") %>%
    # ensure all combinations exist so missing cells show up
    complete(Rep, Afactor, Bfactor)

  # clip color scale within season to show contrasts clearly
  q <- quantile(d$GYtha, c(0.05, 0.95), na.rm = TRUE)
  d <- d %>%
    mutate(
      GYclip = pmin(pmax(GYtha, q[1]), q[2]),
      Afactor = factor(Afactor, levels = c("F1","F2","F3","F4")),
      Bfactor = factor(Bfactor, levels = c("V1","V2","V3","V4","V5","V6")),
      Rep     = factor(Rep, levels = sort(unique(Rep)))
    )

  ggplot(d, aes(x = Bfactor, y = 1, fill = GYclip)) +
    geom_tile(color = "white", height = 0.9) +
    # show missing combos (if any) in light grey
    scale_fill_viridis_c(name = "Yield (kg/ha)", na.value = "grey90") +
    facet_grid(rows = vars(Rep), cols = vars(Afactor), switch = "y") +
    labs(
      title    = paste0(season_label, " — Split-Plot View"),
      subtitle = "Columns: main plot A (N levels); Rows: blocks (Rep); Tiles inside: subplots B (cultivars)",
      x = "Subplot: Cultivar (B)",
      y = "Replication (block)"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      panel.grid = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      strip.text  = element_text(face = "bold"),
      plot.title  = element_text(face = "bold")
    )
}

# Produce the three season figures
p_DS  <- plot_splitplot_season(df, "DS")
p_EWS <- plot_splitplot_season(df, "EWS")
p_LWS <- plot_splitplot_season(df, "LWS")

# If you want to save:
# ggsave("results/DS_splitplot.png",  p_DS,  width=11, height=6, dpi=300)
# ggsave("results/EWS_splitplot.png", p_EWS, width=11, height=6, dpi=300)
# ggsave("results/LWS_splitplot.png", p_LWS, width=11, height=6, dpi=300)

```


```{r}
p_DS
```

```{r}
p_EWS
```

```{r}
p_LWS
```








